<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster v1.0 - Supabase Edition</title>
    <style>
        /* [æ²¡æœ‰ä¿®æ”¹] æ‚¨çš„æ‰€æœ‰ CSS æ ·å¼ä¿æŒä¸å˜ */
        :root {
            --color-primary: #00999F; --color-primary-dark: #007f85; --color-accent: #FEEE30; --color-secondary-blue: #81D2E3; --color-bg-mint: #BCEDD8; --color-text-strong: #065758; --color-background: #f8f9fa; --color-surface: #ffffff; --color-border: #e9ecef; --color-text-primary: var(--color-text-strong); --color-text-secondary: #6c757d; --color-success: #28a745; --color-danger: #e74c3c; --shadow-soft: 0 4px 15px rgba(6, 87, 88, 0.1); --border-radius: 8px;
        }
        html { font-size: 15px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Arial", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background-color: var(--color-background); color: var(--color-text-primary); line-height: 1.6; overflow: hidden; height: 100vh; }
        .app-container { display: flex; height: 100%; padding: 1.2rem; gap: 1.2rem; }
        .sidebar { flex: 0 0 22rem; min-width: 280px; max-width: 350px; background-color: var(--color-surface); border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem; box-shadow: var(--shadow-soft); overflow-y: auto; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--color-surface); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-soft); min-width: 0; }
        .sidebar-section { background-color: var(--color-background); border-radius: 10px; padding: 1rem; flex-shrink: 0; }
        .sidebar-section h3 { font-size: 0.9rem; margin-bottom: 0.8rem; font-weight: 600; color: var(--color-text-primary); }
        button { padding: 0.6rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s, opacity 0.2s; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
        .btn { background-color: #e9ecef; color: var(--color-text-primary); }
        .btn:hover:not(:disabled) { background-color: #dee2e6; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-dark); }
        .tabs { display: flex; border-bottom: 1px solid var(--color-border); padding: 0.5rem 1.5rem 0 1.5rem; flex-shrink: 0; }
        .tab-button { background-color: transparent; font-weight: 500; border-bottom: 3px solid transparent; color: var(--color-text-secondary); }
        .tab-button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .tab-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .tab-pane { display: none; } .tab-pane.active { display: block; }
        input, select, textarea { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); border-radius: 8px; background-color: #fff; font-size: 0.9rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 153, 159, 0.2); }
        #add-task-form { display: grid; grid-template-columns: 2fr 1fr 1fr 1.5fr auto auto; gap: 1rem; align-items: end; margin-bottom: 1.2rem; }
        .task-list-container { height: calc(100% - 90px); overflow-y: auto; }
        #task-table { width: 100%; border-collapse: separate; border-spacing: 0 0.5rem; }
        #task-table thead th { text-align: left; padding: 0.6rem 1rem; color: var(--color-text-secondary); font-weight: 500; font-size: 0.8rem; border-bottom: 1px solid var(--color-border); }
        #task-table tbody tr { border-radius: var(--border-radius); transition: box-shadow 0.2s; }
        #task-table tbody tr:hover { box-shadow: 0 2px 8px rgba(6, 87, 88, 0.1); }
        #task-table tbody td { padding: 0.8rem 1rem; background-color: var(--color-surface); border-top: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); }
        #task-table tbody td:first-child { border-left: 1px solid var(--color-border); border-top-left-radius: var(--border-radius); border-bottom-left-radius: var(--border-radius); }
        #task-table tbody td:last-child { border-right: 1px solid var(--color-border); border-top-right-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .task-name { font-weight: 500; }
        .badge { padding: 3px 10px; border-radius: 16px; font-size: 0.75rem; font-weight: 500; display: inline-block; }
        .urgency-badge.urgency-4 { background-color: var(--color-accent); color: var(--color-text-strong); }
        .urgency-badge.urgency-3 { background-color: rgba(0, 153, 159, 0.15); color: var(--color-primary-dark); }
        .urgency-badge.urgency-2 { background-color: rgba(129, 210, 227, 0.25); color: #0f6270; }
        .urgency-badge.urgency-1 { background-color: var(--color-border); color: var(--color-text-secondary); }
        .status-badge.å·²å®Œæˆ { background-color: #e6f5f5; color: #006970; }
        .status-badge.è¿›è¡Œä¸­ { background-color: var(--color-primary); color: white; }
        .status-badge.å·²æš‚åœ { background-color: var(--color-border); color: var(--color-text-secondary); }
        .status-badge.å¾…åŠ { background-color: #f1f3f5; color: #495057; }
        .inline-edit { -webkit-appearance: none; appearance: none; border: none; background-color: transparent; font: inherit; }
        .stat-date-range { display: flex; flex-direction: column; gap: 0.6rem; margin-top: 0.5rem; }
        #stats-display { display: flex; justify-content: space-around; text-align: center; margin-top: 1rem; }
        .stat-number { font-size: 1.8rem; font-weight: 700; color: var(--color-primary); }
        .urgent-tasks-section { min-height: 150px; display: flex; flex-direction: column; }
        #urgent-tasks-list { list-style-type: none; padding: 0; }
        #urgent-tasks-list li { padding: 0.4rem 0.2rem; font-size: 0.85rem; border-bottom: 1px solid var(--color-border); }
        #urgent-tasks-list li:last-child { border-bottom: none; }
        #urgent-tasks-list li.urgency-4 { font-weight: 600; color: var(--color-primary-dark); }
        #urgent-tasks-list li.urgency-3 { color: var(--color-text-strong); }
        #urgent-tasks-list li.urgency-2 { color: var(--color-text-primary); }
        #urgent-tasks-list li small { display: block; color: var(--color-text-secondary); font-size: 0.75rem; margin-top: 2px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--color-surface); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 6px 20px rgba(44, 62, 80, 0.1); width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-body { overflow-y: auto; padding-right: 1rem; }
        .modal-footer { margin-top: 1.5rem; text-align: right; }
        #edit-daily-progress-container { max-height: 200px; overflow-y: auto; background: var(--color-background); padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <!-- [NEW] è®¤è¯ç•Œé¢å®¹å™¨ -->
    <div id="auth-container" style="display: none; justify-content: center; align-items: center; height: 100vh;">
        <div style="width: 320px; padding: 2rem; background-color: var(--color-surface); border-radius: 8px; box-shadow: var(--shadow-soft);">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">æ¬¢è¿ä½¿ç”¨ TaskMaster</h2>
            <div id="auth-form-container">
                <!-- ç™»å½•è¡¨å• -->
                <form id="login-form" style="display: grid; gap: 1rem;">
                    <input type="email" id="login-email" placeholder="é‚®ç®±" required>
                    <input type="password" id="login-password" placeholder="å¯†ç " required>
                    <button type="submit" class="btn-primary">ç™»å½•</button>
                    <button type="button" id="show-register-btn" class="btn">æ²¡æœ‰è´¦æˆ·ï¼Ÿå»æ³¨å†Œ</button>
                </form>
                <!-- æ³¨å†Œè¡¨å• (é»˜è®¤éšè—) -->
                <form id="register-form" style="display: none; grid-gap: 1rem;">
                    <input type="email" id="register-email" placeholder="é‚®ç®±" required>
                    <input type="password" id="register-password" placeholder="å¯†ç  (è‡³å°‘6ä½)" required>
                    <button type="submit" class="btn-primary">æ³¨å†Œ</button>
                    <button type="button" id="show-login-btn" class="btn">å·²æœ‰è´¦æˆ·ï¼Ÿå»ç™»å½•</button>
                </form>
            </div>
            <p id="auth-error" style="color: var(--color-danger); text-align: center; margin-top: 1rem; min-height: 1.2em;"></p>
        </div>
    </div>

    <!-- [MODIFIED] ä¸»åº”ç”¨å®¹å™¨ï¼Œé»˜è®¤éšè— -->
    <div class="app-container" style="display: none;">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-section"> <input type="text" id="search-box" placeholder="ğŸ” æœç´¢ä»»åŠ¡..."> </div>
            <div class="sidebar-section">
                <h3>æ’åºé€‰é¡¹</h3>
                <div style="display: flex; flex-direction: column; gap: 0.6rem;"> <button id="sort-urgency" class="btn">æŒ‰é‡è¦ç¨‹åº¦</button> <button id="sort-status" class="btn">æŒ‰ä»»åŠ¡çŠ¶æ€</button> <button id="clear-filter" class="btn-primary">æ¸…é™¤ç­›é€‰ä¸æ’åº</button> </div>
            </div>
            <div class="sidebar-section">
                <h3>ä»»åŠ¡ç»Ÿè®¡</h3>
                <div class="stat-date-range"> <label style="font-size:0.8rem; color:var(--color-text-secondary);">å¼€å§‹æ—¥æœŸ:</label> <input type="date" id="stats-start-date"> <label style="font-size:0.8rem; color:var(--color-text-secondary); margin-top:0.5rem;">ç»“æŸæ—¥æœŸ:</label> <input type="date" id="stats-end-date"> </div>
                <div id="stats-display"> <div class="stat-item"><div id="stat-total" class="stat-number">0</div><div class="stat-label">æ€»æ•°</div></div> <div class="stat-item"><div id="stat-completed" class="stat-number" style="color:var(--color-success)">0</div><div class="stat-label">å·²å®Œæˆ</div></div> <div class="stat-item"><div id="stat-pending" class="stat-number" style="color:var(--color-danger)">0</div><div class="stat-label">æœªå®Œæˆ</div></div> </div>
            </div>
            <div class="sidebar-section urgent-tasks-section">
                <h3>ç´§æ€¥ä»»åŠ¡æé†’ (è¿‘2å¤©)</h3>
                <div class="list-container"> <ul id="urgent-tasks-list"></ul> </div>
            </div>
            <div class="sidebar-section">
                <h3>æ•°æ®æ“ä½œ</h3>
                <!-- [MODIFIED] æ·»åŠ äº†ç™»å‡ºæŒ‰é’® -->
                <div style="display: flex; flex-direction: column; gap: 10px;"> 
                    <button id="backup-data" class="btn">å¤‡ä»½æ•°æ®åˆ°æœ¬åœ°</button> 
                    <button id="logout-btn" class="btn" style="background-color: #fdd; color: #c33;">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <nav class="tabs"> <button class="tab-button active" data-tab="tasks">ä»»åŠ¡åˆ—è¡¨</button> <button class="tab-button" data-tab="progress">æ¯å‘¨è¿›å±•</button> </nav>
            <div id="tab-tasks" class="tab-pane active tab-content">
                <form id="add-task-form"> <input type="text" id="task-name" placeholder="è¾“å…¥ä»»åŠ¡åç§°..." required> <input type="date" id="task-start-date" required> <input type="date" id="task-end-date" required> <select id="task-urgency" required></select> <button type="submit" class="btn-primary">æ·»åŠ </button> <button type="button" id="batch-op-btn" class="btn">æ‰¹é‡æ·»åŠ </button> </form>
                <div class="task-list-container">
                    <table id="task-table">
                        <thead><tr><th style="width: 5%;">#</th><th style="width: 40%;">ä»»åŠ¡åç§°</th><th style="width: 15%;">èµ·æ­¢æ—¥æœŸ</th><th style="width: 15%;">é‡è¦ç¨‹åº¦</th><th style="width: 15%;">çŠ¶æ€</th><th style="width: 10%;">æ“ä½œ</th></tr></thead>
                        <tbody id="task-list-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="tab-progress" class="tab-pane tab-content">
                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap;"> <label for="week-selector">é€‰æ‹©å‘¨:</label> <select id="week-selector" style="width: 250px;"></select> <button id="generate-report-btn" class="btn-primary">åˆ·æ–°å‘¨æŠ¥</button> <button id="save-report-btn" class="btn">ä¿å­˜å‘¨æŠ¥</button> </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; height: calc(100% - 60px);">
                    <section style="background-color: var(--color-background); border-radius: 10px; padding: 1.5rem; display: flex; flex-direction: column; overflow: hidden;">
                        <h3>æœ¬å‘¨ç›¸å…³ä»»åŠ¡</h3>
                        <div id="weekly-plan-display" style="flex-grow: 1; overflow-y: auto; background-color: var(--color-surface); padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-size: 0.9rem;"></div>
                    </section>
                    <section style="background-color: var(--color-background); border-radius: 10px; padding: 1.5rem; display: flex; flex-direction: column; overflow: hidden;">
                        <h3>å‘¨æŠ¥æ€»ç»“ (å¯ç¼–è¾‘)</h3>
                        <textarea id="generated-report-area" style="flex-grow: 1; resize: none; border: none; background-color: var(--color-surface); padding: 1rem; border-radius: 8px; font-size: 0.9rem;"></textarea>
                    </section>
                </div>
            </div>
        </main>
    </div>
    
    <!-- æ¨¡æ€æ¡† HTML (æ²¡æœ‰ä¿®æ”¹) -->
    <div id="batch-modal" class="modal"> <div class="modal-content"> <div class="modal-header"><h2>æ‰¹é‡æ·»åŠ ä»»åŠ¡</h2><button class="modal-close" data-target="batch-modal">Ã—</button></div> <div class="modal-body"> <div id="batch-tasks-container"><div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;"><input type="text" class="batch-name" placeholder="ä»»åŠ¡åç§°"><input type="date" class="batch-start-date"><input type="date" class="batch-end-date"><select class="batch-urgency"></select></div></div> <button id="add-batch-row" class="btn" style="margin-top: 10px;">+ æ·»åŠ å¦ä¸€è¡Œ</button> </div> <div class="modal-footer"> <button class="btn modal-close" data-target="batch-modal">å–æ¶ˆ</button> <button id="save-batch-btn" class="btn-primary">ä¿å­˜ä»»åŠ¡</button> </div> </div> </div>
    <div id="edit-modal" class="modal"> <div class="modal-content" style="max-width: 600px;"> <div class="modal-header"><h2>ç¼–è¾‘ä»»åŠ¡</h2><button class="modal-close" data-target="edit-modal">Ã—</button></div> <div class="modal-body"> <input type="hidden" id="edit-task-id"> <div style="border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; margin-bottom: 1rem;"> <h4>å½•å…¥ä»Šæ—¥è¿›å±•</h4> <div style="display: flex; gap: 10px; margin-top: 5px;"><input type="text" id="new-progress-content" placeholder="è¾“å…¥è¿›å±•å†…å®¹..." style="flex-grow: 1;"><button id="add-progress-btn" class="btn">æ·»åŠ </button></div> </div> <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"> <div><label>ä»»åŠ¡åç§°</label><input type="text" id="edit-task-name"></div> <div><label>é‡è¦ç¨‹åº¦</label><select id="edit-task-urgency"></select></div> <div><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="edit-task-start-date"></div> <div><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="edit-task-end-date"></div> </div> <div style="margin-top: 15px;"><label>ä»»åŠ¡çŠ¶æ€</label><select id="edit-task-status"></select></div> <div style="margin-top: 15px;"><label>å¤‡æ³¨</label><textarea id="edit-task-notes" rows="3"></textarea></div> <div style="margin-top: 15px;"> <h4>å†å²è¿›å±•è®°å½•</h4> <div id="edit-daily-progress-container"></div> </div> </div> <div class="modal-footer"> <button class="btn modal-close" data-target="edit-modal">å–æ¶ˆ</button> <button id="save-edit-btn" class="btn-primary">ä¿å­˜æ›´æ”¹</button> </div> </div> </div>

    <!-- [NEW] å¼•å…¥ Supabase JS åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // [NEW] SUPABASE åˆå§‹åŒ–
    // =================================================================================
    // â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“ æŠŠè¿™é‡Œæ›¿æ¢æˆä½ è‡ªå·±çš„ Supabase URL å’Œ Key â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    // â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- å®šä¹‰å¸¸é‡å’Œå…¨å±€å˜é‡ (åŸºæœ¬ä¸å˜) ---
    const URGENCY_LEVELS = {"éå¸¸é‡è¦ç´§æ€¥":{value:4},"é‡è¦ä¸ç´§æ€¥":{value:3},"ç´§æ€¥ä¸é‡è¦":{value:2},"ä¸é‡è¦ä¸ç´§æ€¥":{value:1}};
    const STATUS_OPTIONS = ["å¾…åŠ","è¿›è¡Œä¸­","å·²æš‚åœ","å·²å®Œæˆ"];
    const URGENT_REMINDER_DAYS = 2;
    let tasks = [];
    let weeklyProgress = {};
    let currentSort = { key: 'created_at', reverse: true }; // é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´é™åº
    let currentFilter = '';
    let currentUser = null;

    // --- DOM å…ƒç´ ç¼“å­˜ ---
    const taskListBody = document.getElementById('task-list-body');
    const searchBox = document.getElementById('search-box');
    const statsStartDateInput = document.getElementById('stats-start-date');
    const statsEndDateInput = document.getElementById('stats-end-date');
    const appContainer = document.querySelector('.app-container');
    const authContainer = document.getElementById('auth-container');


    // [NEW] ä¸»æµç¨‹æ§åˆ¶ï¼šè®¤è¯æ£€æŸ¥
    // =================================================================================
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            currentUser = session.user;
            authContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            bootstrapApp(); // ç”¨æˆ·å·²ç™»å½•ï¼Œå¯åŠ¨åº”ç”¨
        } else {
            currentUser = null;
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }
    });

    // [NEW] åº”ç”¨å¯åŠ¨å‡½æ•°
    async function bootstrapApp() {
        await loadData();
        setupEventListeners();
        populateSelect(document.getElementById('task-urgency'), Object.keys(URGENCY_LEVELS));
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('task-start-date').valueAsDate = today;
        document.getElementById('task-end-date').valueAsDate = today;
        statsStartDateInput.valueAsDate = firstDayOfMonth;
        statsEndDateInput.valueAsDate = today;
        render();
    }
    
    // [MODIFIED] æ•°æ®åŠ è½½: ä» Supabase è·å–
    // =================================================================================
    async function loadData() {
        // è·å–ä»»åŠ¡
        const { data: taskData, error: taskError } = await supabase
            .from('tasks')
            .select('*')
            .order('created_at', { ascending: false });

        if (taskError) {
            console.error('è·å–ä»»åŠ¡å¤±è´¥:', taskError);
            alert(`åŠ è½½æ•°æ®å¤±è´¥: ${taskError.message}`);
            tasks = [];
        } else {
            // æ³¨æ„ï¼šdaily_progress å°†åœ¨æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†æ—¶æŒ‰éœ€åŠ è½½
            taskData.forEach(task => task.daily_progress = {}); 
            tasks = taskData;
        }

        // è·å–å‘¨æŠ¥
        const { data: reportData, error: reportError } = await supabase
            .from('weekly_reports')
            .select('*');
        if (reportError) {
            console.error('è·å–å‘¨æŠ¥å¤±è´¥:', reportError);
            weeklyProgress = {};
        } else {
            weeklyProgress = (reportData || []).reduce((acc, report) => {
                acc[report.week_id] = { generated_report: report.report_content };
                return acc;
            }, {});
        }
    }

    // --- [NO CHANGE] æ¸²æŸ“ä¸»å‡½æ•° (å‡ ä¹ä¸å˜) ---
    function render() {
        renderTaskList();
        updateStats();
        updateUrgentTasks();
        populateWeekSelector();
        loadSelectedWeekData();
    }
    
    // --- [NO CHANGE] æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨ (å‡ ä¹ä¸å˜) ---
    function renderTaskList() {
        taskListBody.innerHTML = '';
        const filteredAndSortedTasks = getFilteredAndSortedTasks();
        if (filteredAndSortedTasks.length === 0) {
            taskListBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--color-text-secondary);">æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡...</td></tr>`;
            return;
        }

        const fragment = document.createDocumentFragment();
        filteredAndSortedTasks.forEach((task, index) => {
            const tr = document.createElement('tr');
            tr.dataset.taskId = task.id;
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><div class="task-name">${escapeHtml(task.name)}</div></td>
                <td><div style="font-size: 0.9rem;">${task.start_date}<br><span style="color:var(--color-text-secondary); font-size:0.8rem;">åˆ° ${task.end_date}</span></div></td>
                <td><select class="inline-edit" data-task-id="${task.id}" data-type="urgency"></select></td>
                <td><select class="inline-edit" data-task-id="${task.id}" data-type="status"></select></td>
                <td class="task-actions"><button title="ç¼–è¾‘/æŸ¥çœ‹è¯¦æƒ…">âœï¸</button><button title="åˆ é™¤ä»»åŠ¡">ğŸ—‘ï¸</button></td>
            `;
            
            const applySelectStyles = (select, type) => {
                const badgeClass = type === 'urgency' ? `urgency-${URGENCY_LEVELS[select.value]?.value || 1}` : select.value.replace(/\s+/g, '');
                select.className = `inline-edit badge ${type}-badge ${badgeClass}`;
            };
            
            const urgencySelect = tr.querySelector('[data-type="urgency"]');
            const statusSelect = tr.querySelector('[data-type="status"]');
            
            populateSelect(urgencySelect, Object.keys(URGENCY_LEVELS), task.urgency);
            populateSelect(statusSelect, STATUS_OPTIONS, task.status);
            
            urgencySelect.addEventListener('change', e => { updateTask(e.target.dataset.taskId, 'urgency', e.target.value); applySelectStyles(e.target, 'urgency'); });
            statusSelect.addEventListener('change', e => { updateTask(e.target.dataset.taskId, 'status', e.target.value); applySelectStyles(e.target, 'status'); });
            
            applySelectStyles(urgencySelect, 'urgency');
            applySelectStyles(statusSelect, 'status');
            fragment.appendChild(tr);
        });
        taskListBody.appendChild(fragment);
    }
    
    // --- [NO CHANGE] æ›´æ–°ç»Ÿè®¡/ç´§æ€¥ä»»åŠ¡ (ä¸å˜) ---
    function updateStats() { /* ... ä»£ç ä¸å˜ ... */  let tasksToCount = tasks; const startDateStr = statsStartDateInput.value; const endDateStr = statsEndDateInput.value; if (startDateStr && endDateStr) { const rangeStart = new Date(startDateStr); rangeStart.setHours(0,0,0,0); const rangeEnd = new Date(endDateStr); rangeEnd.setHours(23,59,59,999); tasksToCount = tasks.filter(task => new Date(task.start_date) <= rangeEnd && new Date(task.end_date) >= rangeStart); } document.getElementById('stat-total').textContent = tasksToCount.length; document.getElementById('stat-completed').textContent = tasksToCount.filter(t => t.status === 'å·²å®Œæˆ').length; document.getElementById('stat-pending').textContent = tasksToCount.filter(t => t.status !== 'å·²å®Œæˆ').length;}
    function updateUrgentTasks() { /* ... ä»£ç ä¸å˜ ... */ const list = document.getElementById('urgent-tasks-list'); list.innerHTML = ''; const today = new Date(); today.setHours(0,0,0,0); const reminderDeadline = new Date(); reminderDeadline.setDate(today.getDate() + URGENT_REMINDER_DAYS); const urgentTasks = tasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.end_date && new Date(t.end_date) >= today && new Date(t.end_date) <= reminderDeadline).sort((a,b) => new Date(a.end_date) - new Date(b.end_date)); if (urgentTasks.length === 0) { list.innerHTML = `<li style="color: var(--color-text-secondary); font-style: italic; border: none;">æ— ç´§æ€¥ä»»åŠ¡</li>`; } else { const fragment = document.createDocumentFragment(); urgentTasks.forEach(task => { const li = document.createElement('li'); li.className = `urgency-${URGENCY_LEVELS[task.urgency]?.value || 1}`; li.innerHTML = `${escapeHtml(task.name)}<small>åˆ°æœŸ: ${task.end_date}</small>`; fragment.appendChild(li); }); list.appendChild(fragment); } }

    // [MODIFIED] äº‹ä»¶ç›‘å¬è®¾ç½®
    // =================================================================================
    function setupEventListeners() {
        // ä¸»åº”ç”¨ç›‘å¬å™¨
        document.getElementById('add-task-form').addEventListener('submit', addTask);
        searchBox.addEventListener('input', (e) => { currentFilter = e.target.value; renderTaskList(); });
        document.getElementById('sort-urgency').addEventListener('click', () => setSort('urgency'));
        document.getElementById('sort-status').addEventListener('click', () => setSort('status'));
        document.getElementById('clear-filter').addEventListener('click', () => { searchBox.value = ''; currentFilter = ''; currentSort = { key: 'created_at', reverse: true }; updateSortButtons(); renderTaskList(); });
        statsStartDateInput.addEventListener('change', updateStats);
        statsEndDateInput.addEventListener('change', updateStats);
        document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', (e) => { document.querySelector('.tab-button.active')?.classList.remove('active'); document.querySelector('.tab-pane.active')?.classList.remove('active'); e.currentTarget.classList.add('active'); document.getElementById(`tab-${e.currentTarget.dataset.tab}`).classList.add('active'); }));
        taskListBody.addEventListener('click', e => {
            const targetButton = e.target.closest('button');
            if (!targetButton) return;
            const tr = e.target.closest('tr');
            if(!tr) return;
            const taskId = tr.dataset.taskId;
            if (targetButton.title.includes('åˆ é™¤')) deleteTask(taskId);
            if (targetButton.title.includes('ç¼–è¾‘')) openEditModal(taskId);
        });
        document.getElementById('week-selector').addEventListener('change', loadSelectedWeekData);
        document.getElementById('generate-report-btn').addEventListener('click', generateWeeklyReport);
        document.getElementById('save-report-btn').addEventListener('click', saveWeeklyReport);
        document.getElementById('backup-data').addEventListener('click', backupData);
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.currentTarget.dataset.target)));

        // [NEW] ç™»å‡ºæŒ‰é’®
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
        });

        setupBatchModalListeners();
        setupEditModalListeners();
    }
    
    // [NEW] è®¤è¯ç›¸å…³äº‹ä»¶ç›‘å¬
    function setupAuthEventListeners() {
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = 'ç™»å½•ä¸­...';
            const { error } = await supabase.auth.signInWithPassword({
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value,
            });
            if (error) authError.textContent = `ç™»å½•å¤±è´¥: ${error.message}`;
            else authError.textContent = '';
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            authError.textContent = 'æ³¨å†Œä¸­...';
            const { error } = await supabase.auth.signUp({
                email: document.getElementById('register-email').value,
                password: document.getElementById('register-password').value,
            });
            if (error) {
                authError.textContent = `æ³¨å†Œå¤±è´¥: ${error.message}`;
            } else {
                authError.textContent = 'æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ä»¥å®ŒæˆéªŒè¯ã€‚';
                loginForm.style.display = 'grid';
                registerForm.style.display = 'none';
            }
        });

        document.getElementById('show-register-btn').addEventListener('click', () => {
            loginForm.style.display = 'none'; registerForm.style.display = 'grid'; authError.textContent = '';
        });
        document.getElementById('show-login-btn').addEventListener('click', () => {
            loginForm.style.display = 'grid'; registerForm.style.display = 'none'; authError.textContent = '';
        });
    }
    
    // [NO CHANGE] æ‰¹é‡æ¨¡æ€æ¡†ç›‘å¬
    function setupBatchModalListeners() { /* ... ä»£ç ä¸å˜ ... */ const batchModal = document.getElementById('batch-modal'); document.getElementById('batch-op-btn').addEventListener('click', () => openModal('batch-modal')); batchModal.querySelector('#save-batch-btn').addEventListener('click', saveManualBatch); batchModal.querySelector('#add-batch-row').addEventListener('click', () => { const container = batchModal.querySelector('#batch-tasks-container'); const newRow = container.firstElementChild.cloneNode(true); newRow.querySelectorAll('input').forEach(i => i.value = ''); populateSelect(newRow.querySelector('.batch-urgency'), Object.keys(URGENCY_LEVELS)); container.appendChild(newRow); }); populateSelect(batchModal.querySelector('.batch-urgency'), Object.keys(URGENCY_LEVELS));}
    
    // [NO CHANGE] ç¼–è¾‘æ¨¡æ€æ¡†ç›‘å¬ (ä½†å…¶è°ƒç”¨çš„å‡½æ•°å·²è¢«ä¿®æ”¹)
    function setupEditModalListeners(){ /* ... ä»£ç ä¸å˜ ... */ const editModal = document.getElementById('edit-modal'); editModal.querySelector('#save-edit-btn').addEventListener('click', saveEditTask); editModal.querySelector('#add-progress-btn').addEventListener('click', addDailyProgress); editModal.querySelector('#edit-daily-progress-container').addEventListener('click', e => { const deleteBtn = e.target.closest('.delete-progress-btn'); if (deleteBtn) { const { progressId } = deleteBtn.dataset; deleteDailyProgress(document.getElementById('edit-task-id').value, progressId); } });}

    // [MODIFIED] CRUD åŠæ ¸å¿ƒåŠŸèƒ½å‡½æ•°ï¼Œå…¨éƒ¨æ”¹ä¸º async
    // =================================================================================
    
    async function addTask(e) {
        e.preventDefault();
        const form = e.target;
        const name = form.querySelector('#task-name').value.trim();
        const startDate = form.querySelector('#task-start-date').value;
        const endDate = form.querySelector('#task-end-date').value;
        const urgency = form.querySelector('#task-urgency').value;
        if (!name || !startDate || !endDate || !urgency) { alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼'); return; }
        if (new Date(endDate) < new Date(startDate)) { alert('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸï¼'); return; }
        
        const { data, error } = await supabase.from('tasks').insert({ name, start_date: startDate, end_date: endDate, urgency, status: 'å¾…åŠ' }).select();
        
        if (error) {
            alert(`æ·»åŠ å¤±è´¥: ${error.message}`);
        } else {
            const newTask = { ...data[0], daily_progress: {} };
            tasks.unshift(newTask);
            render();
            form.reset();
            form.querySelector('#task-start-date').valueAsDate = new Date();
            form.querySelector('#task-end-date').valueAsDate = new Date();
        }
    }
    
    async function updateTask(id, field, value) {
        const { error } = await supabase.from('tasks').update({ [field]: value }).eq('id', id);
        if (error) {
            alert(`æ›´æ–°å¤±è´¥: ${error.message}`);
        } else {
            const task = tasks.find(t => t.id === id);
            if(task) task[field] = value;
            render();
        }
    }

    async function deleteTask(id) {
        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤å…¶æ‰€æœ‰è¿›å±•è®°å½•ï¼')) {
            const { error } = await supabase.from('tasks').delete().eq('id', id);
            if(error) {
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
            } else {
                tasks = tasks.filter(t => t.id !== id);
                render();
            }
        }
    }
    
    async function openEditModal(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        const modal = document.getElementById('edit-modal');
        // å…ˆå¡«å……åŸºæœ¬ä¿¡æ¯
        modal.querySelector('#edit-task-id').value = taskId;
        modal.querySelector('#edit-task-name').value = task.name;
        modal.querySelector('#edit-task-start-date').value = task.start_date;
        modal.querySelector('#edit-task-end-date').value = task.end_date;
        modal.querySelector('#edit-task-notes').value = task.notes || '';
        populateSelect(modal.querySelector('#edit-task-urgency'), Object.keys(URGENCY_LEVELS), task.urgency);
        populateSelect(modal.querySelector('#edit-task-status'), STATUS_OPTIONS, task.status);
        
        // å¼‚æ­¥è·å–å¹¶æ¸²æŸ“æ¯æ—¥è¿›å±•
        renderDailyProgressEditor(task.id, []); // å…ˆæ¸…ç©ºå¹¶æ˜¾ç¤ºåŠ è½½ä¸­...
        openModal('edit-modal');
        const { data, error } = await supabase.from('daily_progress').select('*').eq('task_id', taskId).order('created_at', { ascending: false });
        if (error) {
            alert('æ— æ³•åŠ è½½è¿›å±•è®°å½•ã€‚');
        } else {
            task.daily_progress = data || [];
            renderDailyProgressEditor(task.id, task.daily_progress);
        }
    }

    function renderDailyProgressEditor(taskId, progressEntries) {
        const container = document.getElementById('edit-daily-progress-container');
        if (progressEntries.length === 0) {
            container.innerHTML = '<p style="color: var(--color-text-secondary); font-style: italic;">æ— è¿›å±•è®°å½•</p>';
            return;
        }
        
        // æŒ‰æ—¥æœŸåˆ†ç»„
        const groupedByDate = progressEntries.reduce((acc, entry) => {
            const date = entry.progress_date;
            if (!acc[date]) acc[date] = [];
            acc[date].push(entry);
            return acc;
        }, {});

        const fragment = document.createDocumentFragment();
        Object.keys(groupedByDate).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
            const dateGroup = document.createElement('div');
            dateGroup.style.marginBottom = '10px';
            dateGroup.innerHTML = `<strong>${date}</strong>`;
            const ul = document.createElement('ul');
            ul.style.listStyle = 'none'; ul.style.paddingLeft = '15px';
            groupedByDate[date].forEach(entry => {
                const li = document.createElement('li');
                li.style.display = 'flex'; li.style.justifyContent = 'space-between';
                li.innerHTML = `<span>${escapeHtml(entry.content)}</span> <button class="delete-progress-btn" data-progress-id="${entry.id}" style="color:red; background:none; border:none; cursor:pointer; font-size:1.2em; line-height:1;">Ã—</button>`;
                ul.appendChild(li);
            });
            dateGroup.appendChild(ul);
            fragment.appendChild(dateGroup);
        });
        container.innerHTML = ''; // æ¸…ç©º
        container.appendChild(fragment);
    }

    async function saveEditTask() {
        const id = document.getElementById('edit-task-id').value;
        const task = tasks.find(t => t.id === id);
        if (task) {
            const updates = {
                name: document.getElementById('edit-task-name').value,
                start_date: document.getElementById('edit-task-start-date').value,
                end_date: document.getElementById('edit-task-end-date').value,
                urgency: document.getElementById('edit-task-urgency').value,
                status: document.getElementById('edit-task-status').value,
                notes: document.getElementById('edit-task-notes').value
            };
            const { error } = await supabase.from('tasks').update(updates).eq('id', id);
            if (error) {
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            } else {
                Object.assign(task, updates);
                render();
                closeModal('edit-modal');
            }
        }
    }

    async function addDailyProgress() {
        const taskId = document.getElementById('edit-task-id').value;
        const contentInput = document.getElementById('new-progress-content');
        const content = contentInput.value.trim();
        if (!taskId || !content) return;
        
        const { data, error } = await supabase.from('daily_progress').insert({ task_id: taskId, content: content }).select();
        
        if (error) {
            alert(`æ·»åŠ è¿›å±•å¤±è´¥: ${error.message}`);
        } else {
            const task = tasks.find(t => t.id === taskId);
            task.daily_progress.unshift(data[0]);
            renderDailyProgressEditor(taskId, task.daily_progress);
            contentInput.value = '';
        }
    }

    async function deleteDailyProgress(taskId, progressId) {
        if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡è¿›å±•è®°å½•å—ï¼Ÿ')) return;
        const { error } = await supabase.from('daily_progress').delete().eq('id', progressId);
        if (error) {
            alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
        } else {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.daily_progress = task.daily_progress.filter(p => p.id !== Number(progressId));
                renderDailyProgressEditor(taskId, task.daily_progress);
            }
        }
    }
    
    async function saveWeeklyReport() {
        const selectedWeekId = document.getElementById('week-selector').value;
        if (!selectedWeekId) return;
        const reportContent = document.getElementById('generated-report-area').value;

        // upsert = update or insert. å¦‚æœè®°å½•å·²å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥
        const { error } = await supabase.from('weekly_reports').upsert({
            week_id: selectedWeekId,
            report_content: reportContent,
            user_id: currentUser.id
        }, { onConflict: 'user_id, week_id' }); // æŒ‡å®šå†²çªçš„åˆ—

        if (error) {
            alert(`å‘¨æŠ¥ä¿å­˜å¤±è´¥: ${error.message}`);
        } else {
            weeklyProgress[selectedWeekId] = { generated_report: reportContent };
            alert('å‘¨æŠ¥å·²ä¿å­˜ï¼');
        }
    }

    async function saveManualBatch() {
        const container = document.getElementById('batch-tasks-container');
        const newTasks = [];
        container.querySelectorAll('div').forEach(row => {
            const name = row.querySelector('.batch-name').value.trim();
            const startDate = row.querySelector('.batch-start-date').value;
            const endDate = row.querySelector('.batch-end-date').value;
            const urgency = row.querySelector('.batch-urgency').value;
            if(name && startDate && endDate && urgency) {
                newTasks.push({ name, start_date: startDate, end_date: endDate, urgency, status: 'å¾…åŠ' });
            }
        });

        if (newTasks.length > 0) {
            const { data, error } = await supabase.from('tasks').insert(newTasks).select();
            if (error) {
                alert(`æ‰¹é‡æ·»åŠ å¤±è´¥: ${error.message}`);
            } else {
                const addedTasks = data.map(t => ({...t, daily_progress: {}}));
                tasks.unshift(...addedTasks);
                render();
                alert(`æˆåŠŸæ·»åŠ  ${data.length} ä¸ªä»»åŠ¡ï¼`);
                closeModal('batch-modal');
            }
        } else {
            alert('æ²¡æœ‰è¾“å…¥ä»»ä½•æœ‰æ•ˆçš„ä»»åŠ¡ã€‚');
        }
    }
    
    function backupData() { const dataToBackup = { tasks, weeklyProgress }; const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `TaskMaster_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); }
    function getFilteredAndSortedTasks() { let result = [...tasks]; if (currentFilter) { const searchTerm = currentFilter.toLowerCase(); result = result.filter(task => Object.values(task).some(val => String(val).toLowerCase().includes(searchTerm))); } const { key, reverse } = currentSort; result.sort((a, b) => { let valA, valB; switch(key) { case 'urgency': valA = URGENCY_LEVELS[a.urgency]?.value || 0; valB = URGENCY_LEVELS[b.urgency]?.value || 0; break; case 'status': valA = STATUS_OPTIONS.indexOf(a.status); valB = STATUS_OPTIONS.indexOf(b.status); break; default: valA = new Date(a.created_at); valB = new Date(b.created_at); } if (valA < valB) return reverse ? 1 : -1; if (valA > valB) return reverse ? -1 : 1; return 0; }); return result; }
    function setSort(key) { if (currentSort.key === key) { currentSort.reverse = !currentSort.reverse; } else { currentSort.key = key; currentSort.reverse = (key === 'urgency'); } updateSortButtons(); renderTaskList(); }
    function updateSortButtons() { document.querySelectorAll('.sidebar-section button[id^="sort-"]').forEach(btn => { btn.classList.remove('btn-primary'); let baseText = {'sort-urgency':'æŒ‰é‡è¦ç¨‹åº¦','sort-status':'æŒ‰ä»»åŠ¡çŠ¶æ€'}[btn.id]; const key = btn.id.replace('sort-', ''); if(currentSort.key === key) { btn.classList.add('btn-primary'); btn.textContent = `${baseText} ${currentSort.reverse ? 'â–¼' : 'â–²'}`; } else { btn.textContent = baseText; } }); }
    function populateSelect(select, options, selectedValue = null) { select.innerHTML = options.map(opt => `<option value="${escapeHtml(opt)}" ${opt === selectedValue ? 'selected' : ''}>${escapeHtml(opt)}</option>`).join(''); }
    function escapeHtml(str) { return String(str || '').replace(/[&<>"']/g, m => ({'&':'&','<':'<','>':'>','"':'"',"'":'''})[m]); }
    function openModal(id) { document.getElementById(id)?.classList.add('active'); }
    function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }
    function getWeekIdFromDate(d) { const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1)); const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7); return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`; }
    function getWeekStartEndDates(weekId) { const [year, week] = weekId.split('-W').map(Number); const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7)); const day = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 1 - day); return [new Date(d), new Date(d.setUTCDate(d.getUTCDate() + 6))]; }
    function formatDate(date, full = false) { return date.toLocaleDateString('zh-CN', { year: full?'numeric':undefined, month: '2-digit', day: '2-digit' }).replace(/\//g, '-'); }
    function populateWeekSelector() { const weekIds = new Set(); tasks.forEach(task => { if (task.start_date) weekIds.add(getWeekIdFromDate(new Date(task.start_date))); if (task.end_date) weekIds.add(getWeekIdFromDate(new Date(task.end_date))); Object.keys(task.daily_progress || {}).forEach(dateStr => weekIds.add(getWeekIdFromDate(new Date(dateStr)))); }); Object.keys(weeklyProgress).forEach(weekId => weekIds.add(weekId)); weekIds.add(getWeekIdFromDate(new Date())); const sortedWeeks = Array.from(weekIds).sort().reverse(); const selector = document.getElementById('week-selector'); selector.innerHTML = sortedWeeks.map(weekId => { const [start, end] = getWeekStartEndDates(weekId); return `<option value="${weekId}">${weekId} (${formatDate(start)} - ${formatDate(end)})</option>`; }).join(''); const currentWeekId = getWeekIdFromDate(new Date()); if(sortedWeeks.includes(currentWeekId)) selector.value = currentWeekId; }
    function loadSelectedWeekData() { const selectedWeekId = document.getElementById('week-selector').value; if (!selectedWeekId) return; const [weekStart, weekEnd] = getWeekStartEndDates(selectedWeekId); const relevantTasks = tasks.filter(task => new Date(task.start_date) <= weekEnd && new Date(task.end_date) >= weekStart); document.getElementById('weekly-plan-display').innerHTML = relevantTasks.length > 0 ? '<ul>' + relevantTasks.map(t => `<li><strong>${escapeHtml(t.name)}</strong><br><small>${t.status} | ${t.urgency}</small></li>`).join('') + '</ul>' : '<p style="color: var(--color-text-secondary);">æœ¬å‘¨æ— ç›¸å…³è®¡åˆ’ä»»åŠ¡ã€‚</p>'; document.getElementById('generated-report-area').value = weeklyProgress[selectedWeekId]?.generated_report || ''; }
    function generateWeeklyReport() { const selectedWeekId = document.getElementById('week-selector').value; if (!selectedWeekId) return; const [weekStart, weekEnd] = getWeekStartEndDates(selectedWeekId); let reportText = `## å‘¨æŠ¥ (${selectedWeekId})\nå‘¨æœŸ: ${formatDate(weekStart, true)} è‡³ ${formatDate(weekEnd, true)}\n\n--- æœ¬å‘¨ä»»åŠ¡è¿›å±•ä¸è®°å½• ---\n\n`; const tasksWithActivity = tasks.filter(task => (new Date(task.start_date) <= weekEnd && new Date(task.end_date) >= weekStart)); if (tasksWithActivity.length === 0) { reportText += "æœ¬å‘¨æ²¡æœ‰ç›¸å…³ä»»åŠ¡ã€‚\n"; } else { tasksWithActivity.forEach(task => { reportText += `### ä»»åŠ¡: ${task.name} (${task.status}, ${task.urgency})\n`; const progressInWeek = (task.daily_progress || []).filter(p => new Date(p.progress_date) >= weekStart && new Date(p.progress_date) <= weekEnd); if (progressInWeek.length > 0) { progressInWeek.sort((a,b) => new Date(a.progress_date) - new Date(b.progress_date)).forEach(entry => { reportText += `  - ${entry.progress_date}: ${entry.content}\n`; }); } else { reportText += `  - æœ¬å‘¨æ— æ˜ç¡®è¿›å±•è®°å½•ã€‚\n`; } if (task.status === 'å·²å®Œæˆ' && new Date(task.end_date) >= weekStart && new Date(task.end_date) <= weekEnd) { reportText += `  - ä»»åŠ¡äº ${task.end_date} å®Œæˆã€‚\n`; } reportText += "\n"; }); } document.getElementById('generated-report-area').value = reportText; }

    // åˆå§‹åŒ–è®¤è¯ç›‘å¬
    setupAuthEventListeners();
    
});
</script>

</body>
</html>
