<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supabase 任务管理</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* 基础样式，可替换为 TaskMaster 主题 */
    :root { --primary: #00999F; --primary-dark: #007f85; --accent: #FEEE30; --bg: #f8f9fa; --surface: #fff; --border: #e9ecef; --text: #065758; --shadow: 0 4px 15px rgba(6,87,88,0.1); --radius:8px; }
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); }
    .hidden { display:none; }
    h2 { margin-bottom: 1rem; }
    input, select, button, textarea { padding:0.6rem; border:1px solid var(--border); border-radius:var(--radius); font-size:0.9rem; }
    button { background: var(--primary); color: #fff; cursor: pointer; }
    button:hover { background: var(--primary-dark); }
    table { width:100%; border-collapse: separate; border-spacing:0 0.5rem; }
    th, td { padding:0.8rem 1rem; background: var(--surface); }
    th { background: var(--bg); color: var(--text); font-weight:600; }
    .inline-edit { background:transparent; border:none; cursor:pointer; }
    .badge { padding:2px 8px; border-radius:16px; font-size:0.75rem; }
    .badge-urgency-4 { background: var(--accent); color: var(--text); }
    .badge-urgency-3 { background: rgba(0,153,159,0.15); color: var(--primary-dark); }
    .badge-urgency-2 { background: rgba(129,210,227,0.25); color:#0f6270; }
    .badge-urgency-1 { background: var(--border); color:#6c757d; }
    .badge-status-已完成 { background:#e6f5f5; color:#006970; }
    .badge-status-进行中 { background:var(--primary); color:#fff; }
    .badge-status-已暂停 { background:var(--border); color:#6c757d; }
    .badge-status-待办 { background:#f1f3f5; color:#495057; }
    .sidebar, .main { background:var(--surface); border-radius:var(--radius); padding:1rem; box-shadow:var(--shadow); }
    .app { display:flex; gap:1rem; }
    .sidebar { flex:0 0 250px; display:flex; flex-direction:column; gap:1rem; }
    .sidebar section { }
    .main { flex:1; display:flex; flex-direction:column; }
    .tabs { display:flex; border-bottom:1px solid var(--border); }
    .tab-btn { flex:1; padding:0.8rem; background:transparent; border:none; cursor:pointer; }
    .tab-btn.active { border-bottom:3px solid var(--primary); color:var(--primary); }
    .tab-content { flex:1; overflow:auto; padding:1rem; }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; visibility:hidden; }
    .modal.active { visibility:visible; }
    .modal .content { background:var(--surface); padding:1.5rem; border-radius:var(--radius); max-width:600px; width:100%; max-height:90vh; overflow:auto; }
    .modal header { display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
<div class="container">
  <!-- 登录注册 -->
  <div id="login" class="container">
    <h2>登录 / 注册</h2>
    <input id="email" type="email" placeholder="邮箱" /><br/>
    <input id="password" type="password" placeholder="密码" /><br/>
    <button id="btn-signup">注册</button>
    <button id="btn-login">登录</button>
    <button id="btn-github">GitHub 登录</button>
    <p id="login-msg" style="color:red;"></p>
  </div>
  <!-- 主应用 -->
  <div id="app" class="hidden app">
    <aside class="sidebar">
      <section>
        <input id="search-box" placeholder="🔍 搜索任务..." />
      </section>
      <section>
        <h3>排序</h3>
        <button id="sort-urgency" class="btn">按重要程度</button>
        <button id="sort-status" class="btn">按状态</button>
        <button id="clear-filter" class="btn">清除</button>
      </section>
      <section>
        <h3>统计</h3>
        <label>开始:</label><input id="stats-start-date" type="date" /><br/>
        <label>结束:</label><input id="stats-end-date" type="date" />
        <div><strong>总:</strong><span id="stat-total">0</span></div>
        <div><strong>完成:</strong><span id="stat-completed">0</span></div>
        <div><strong>未完:</strong><span id="stat-pending">0</span></div>
      </section>
      <section>
        <h3>紧急任务 (2天内)</h3>
        <ul id="urgent-tasks-list"></ul>
      </section>
      <section>
        <button id="backup-data">本地备份</button>
      </section>
    </aside>
    <main class="main">
      <nav class="tabs">
        <button data-tab="tasks" class="tab-btn active">任务列表</button>
        <button data-tab="progress" class="tab-btn">每周进展</button>
      </nav>
      <div id="tab-tasks" class="tab-content">
        <form id="add-task-form" style="display:flex;gap:0.5rem;flex-wrap:wrap;">
          <input id="task-name" placeholder="任务名称" required />
          <input id="task-start" type="date" required />
          <input id="task-end" type="date" required />
          <select id="task-urgency" required>
            <option>非常重要紧急</option><option>重要不紧急</option><option>紧急不重要</option><option>不重要不紧急</option>
          </select>
          <button type="submit">添加</button>
          <button type="button" id="batch-op-btn">批量添加</button>
        </form>
        <table>
          <thead><tr><th>#</th><th>名称</th><th>起止</th><th>重要度</th><th>状态</th><th>操作</th></tr></thead>
          <tbody id="task-list-body"></tbody>
        </table>
      </div>
      <div id="tab-progress" class="tab-content hidden">
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <label>周:</label><select id="week-selector" style="flex:1;"></select>
          <button id="generate-report-btn">刷新周报</button>
          <button id="save-report-btn">保存周报</button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
          <section><h3>本周任务</h3><div id="weekly-plan-display"></div></section>
          <section><h3>周报总结</h3><textarea id="generated-report-area" style="width:100%;height:100%;"></textarea></section>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- 模态：批量 -->
<div id="batch-modal" class="modal">
  <div class="content">
    <header><h3>批量添加</h3><button onclick="closeModal('batch-modal')">×</button></header>
    <div id="batch-tasks-container"></div>
    <button id="add-batch-row">+ 行</button>
    <button id="save-batch-btn">保存</button>
  </div>
</div>
<!-- 编辑模态 -->
<div id="edit-modal" class="modal">
  <div class="content">
    <header><h3>编辑任务</h3><button onclick="closeModal('edit-modal')">×</button></header>
    <div><input type="hidden" id="edit-task-id"/></div>
    <div><input id="edit-task-name"/><select id="edit-task-urgency"></select><input id="edit-task-start-date" type="date"/><input id="edit-task-end-date" type="date"/><select id="edit-task-status"></select></div>
    <div><textarea id="edit-task-notes" placeholder="备注"></textarea></div>
    <div><h4>新增进展</h4><input id="new-progress-content"/><button id="add-progress-btn">添加</button></div>
    <div id="edit-daily-progress-container"></div>
    <button id="save-edit-btn">保存</button>
  </div>
</div>

<script>
  // Supabase init
  const SUPABASE_URL='https://oprqecajnzvzusjqqolk.supabase.co';
  const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wcnFlY2Fqbnp2enVzanFxb2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTQzMzMsImV4cCI6MjA2OTU5MDMzM30.lY691Yw7u6ipUxXW6inYAnkv-ohJT96OWTAU-usMJOw';
  const supabase=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
  // 常量
  const URGENCY_LEVELS={"非常重要紧急":4,"重要不紧急":3,"紧急不重要":2,"不重要不紧急":1};
  const STATUS_OPTIONS=["待办","进行中","已暂停","已完成"];
  const URGENT_DAYS=2;
  let tasks=[],weeklyProgress={},currentSort={key:'createdAt',reverse:false},currentFilter='';

  // DOM 缓存
  const loginEl=document.getElementById('login'),appEl=document.getElementById('app'),msgEl=document.getElementById('login-msg');
  const taskListBody=document.getElementById('task-list-body'),searchBox=document.getElementById('search-box');
  const statsStartDateInput=document.getElementById('stats-start-date'),statsEndDateInput=document.getElementById('stats-end-date');

  // 认证
  document.getElementById('btn-signup').onclick=async()=>{const e=document.getElementById('email').value,p=document.getElementById('password').value;let{error}=await supabase.auth.signUp({email:e,password:p});msgEl.textContent=error?error.message:'注册成功';};
  document.getElementById('btn-login').onclick=async()=>{const e=document.getElementById('email').value,p=document.getElementById('password').value;let{error}=await supabase.auth.signInWithPassword({email:e,password:p});msgEl.textContent=error?error.message:'';};
  document.getElementById('btn-github').onclick=()=>supabase.auth.signInWithOAuth({provider:'github'});
  document.getElementById('btn-logout').onclick=async()=>{await supabase.auth.signOut();showLogin();};
  supabase.auth.onAuthStateChange((_,session)=>{session?.user?showApp():showLogin();});
  function showLogin(){loginEl.classList.remove('hidden');appEl.classList.add('hidden');msgEl.textContent='';}
  async function showApp(){loginEl.classList.add('hidden');appEl.classList.remove('hidden');await initialize();}

  // 初始化
  async function initialize(){await loadData();setupListeners();render();}
  async function loadData(){const{data:user}=await supabase.auth.getUser();tasks=(await supabase.from('tasks').select('*').eq('user_id',user.id)).data||[];weeklyProgress=(await supabase.from('progress').select('*')).data.reduce((acc,p)=>{acc[getWeekIdFromDate(new Date(p.date))]=acc[getWeekIdFromDate(new Date(p.date))]||{generated_report:''};return acc;},{});}  

  function setupListeners(){
    document.getElementById('add-task-form').addEventListener('submit',addTask);
    searchBox.addEventListener('input',e=>{currentFilter=e.target.value;renderTaskList();});
    document.getElementById('sort-urgency').onclick=()=>{setSort('urgency');};
    document.getElementById('sort-status').onclick=()=>{setSort('status');};
    document.getElementById('clear-filter').onclick=()=>{searchBox.value=currentFilter='';currentSort={key:'createdAt',reverse:false};renderTaskList();};
    statsStartDateInput.onchange=updateStats;statsEndDateInput.onchange=updateStats;
    document.querySelectorAll('.tab-btn').forEach(btn=>btn.onclick=e=>switchTab(e.target.dataset.tab));
    taskListBody.onclick=e=>handleRowClick(e);
    document.getElementById('generate-report-btn').onclick=generateWeeklyReport;
    document.getElementById('save-report-btn').onclick=saveWeeklyReport;
    document.getElementById('backup-data').onclick=backupData;
    setupBatchModal();setupEditModal();
  }

  // 渲染
  function render(){renderTaskList();updateStats();updateUrgentTasks();populateWeekSelector();loadSelectedWeekData();}
  function renderTaskList(){/* 同前 */}
  function updateStats(){/* 同前 */}
  function updateUrgentTasks(){/* 同前 */}
  function populateWeekSelector(){/* 同前 */}
  function loadSelectedWeekData(){/* 同前 */}
  function generateWeeklyReport(){/* 同前 */}
  function saveWeeklyReport(){/* 同前 */}
  function backupData(){/* 同前 */}
  function addTask(e){e.preventDefault();/* Supabase 插入 */ render();}
  function switchTab(tab){/* 切换选项卡 */}
  function handleRowClick(e){/* 编辑删除 */}
  function setupBatchModal(){/* 初始化批量模态 */}
  function setupEditModal(){/* 初始化编辑模态 */}
  function getWeekIdFromDate(d){/* 同前 */}

</script>
</body>
</html>
