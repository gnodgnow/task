<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Cloud</title>
    <!-- 引入 Supabase JS 客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 全新配色方案 */
        :root {
            --color-primary: #00999F; --color-primary-dark: #007f85; --color-accent: #FEEE30; --color-secondary-blue: #81D2E3; --color-bg-mint: #BCEDD8; --color-text-strong: #065758; --color-background: #f8f9fa; --color-surface: #ffffff; --color-border: #e9ecef; --color-text-primary: var(--color-text-strong); --color-text-secondary: #6c757d; --color-success: #28a745; --color-danger: #e74c3c; --shadow-soft: 0 4px 15px rgba(6, 87, 88, 0.1); --border-radius: 8px;
        }
        html { font-size: 15px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Arial", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* 认证界面样式 */
        #auth-container {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            text-align: center;
        }
        #auth-container h1 { color: var(--color-primary); margin-bottom: 2rem; }
        .auth-form { display: flex; flex-direction: column; gap: 1rem; }
        .auth-form input { margin-bottom: 0.5rem; }
        .auth-form button { width: 100%; }
        #auth-toggle { margin-top: 1.5rem; background: none; border: none; color: var(--color-primary); cursor: pointer; font-size: 0.9rem; }
        #auth-message { margin-top: 1rem; color: var(--color-danger); font-size: 0.9rem; min-height: 1.2rem; }
        #app-loading { text-align: center; font-size: 1.5rem; color: var(--color-primary); }

        /* 主应用容器默认隐藏 */
        .app-container {
            display: none;
            width: 100%;
            height: 100%;
            padding: 1.2rem;
            gap: 1.2rem;
        }

        /* 您的其他样式 */
        .sidebar { flex: 0 0 22rem; min-width: 280px; max-width: 350px; background-color: var(--color-surface); border-radius: var(--border-radius); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.2rem; box-shadow: var(--shadow-soft); overflow-y: auto; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--color-surface); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-soft); min-width: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; background-color: var(--color-background); padding: 1rem; border-radius: 10px; flex-shrink: 0; }
        .sidebar-section { background-color: var(--color-background); border-radius: 10px; padding: 1rem; flex-shrink: 0; }
        .sidebar-section h3 { font-size: 0.9rem; margin-bottom: 0.8rem; font-weight: 600; color: var(--color-text-primary); }
        button { padding: 0.6rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.2s, opacity 0.2s; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
        .btn { background-color: #e9ecef; color: var(--color-text-primary); }
        .btn:hover:not(:disabled) { background-color: #dee2e6; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-dark); }
        .tabs { display: flex; border-bottom: 1px solid var(--color-border); padding: 0.5rem 1.5rem 0 1.5rem; flex-shrink: 0; }
        .tab-button { background-color: transparent; font-weight: 500; border-bottom: 3px solid transparent; color: var(--color-text-secondary); }
        .tab-button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .tab-content { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .tab-pane { display: none; } .tab-pane.active { display: block; }
        input, select, textarea { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--color-border); border-radius: 8px; background-color: #fff; font-size: 0.9rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(0, 153, 159, 0.2); }
        #add-task-form { display: grid; grid-template-columns: 2fr 1fr 1fr 1.5fr auto auto; gap: 1rem; align-items: end; margin-bottom: 1.2rem; }
        .task-list-container { height: calc(100% - 90px); overflow-y: auto; }
        #task-table { width: 100%; border-collapse: separate; border-spacing: 0 0.5rem; }
        #task-table thead th { text-align: left; padding: 0.6rem 1rem; color: var(--color-text-secondary); font-weight: 500; font-size: 0.8rem; border-bottom: 1px solid var(--color-border); }
        #task-table tbody tr { border-radius: var(--border-radius); transition: box-shadow 0.2s; }
        #task-table tbody tr:hover { box-shadow: 0 2px 8px rgba(6, 87, 88, 0.1); }
        #task-table tbody td { padding: 0.8rem 1rem; background-color: var(--color-surface); border-top: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); }
        #task-table tbody td:first-child { border-left: 1px solid var(--color-border); border-top-left-radius: var(--border-radius); border-bottom-left-radius: var(--border-radius); }
        #task-table tbody td:last-child { border-right: 1px solid var(--color-border); border-top-right-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .task-name { font-weight: 500; }
        .badge { padding: 3px 10px; border-radius: 16px; font-size: 0.75rem; font-weight: 500; display: inline-block; }
        .urgency-badge.urgency-4 { background-color: var(--color-accent); color: var(--color-text-strong); }
        .urgency-badge.urgency-3 { background-color: rgba(0, 153, 159, 0.15); color: var(--color-primary-dark); }
        .urgency-badge.urgency-2 { background-color: rgba(129, 210, 227, 0.25); color: #0f6270; }
        .urgency-badge.urgency-1 { background-color: var(--color-border); color: var(--color-text-secondary); }
        .status-badge.已完成 { background-color: #e6f5f5; color: #006970; }
        .status-badge.进行中 { background-color: var(--color-primary); color: white; }
        .status-badge.已暂停 { background-color: var(--color-border); color: var(--color-text-secondary); }
        .status-badge.待办 { background-color: #f1f3f5; color: #495057; }
        .inline-edit { -webkit-appearance: none; appearance: none; border: none; background-color: transparent; font: inherit; }
        .stat-date-range { display: flex; flex-direction: column; gap: 0.6rem; margin-top: 0.5rem; }
        #stats-display { display: flex; justify-content: space-around; text-align: center; margin-top: 1rem; }
        .stat-number { font-size: 1.8rem; font-weight: 700; color: var(--color-primary); }
        .urgent-tasks-section { min-height: 150px; display: flex; flex-direction: column; }
        #urgent-tasks-list { list-style-type: none; padding: 0; }
        #urgent-tasks-list li { padding: 0.4rem 0.2rem; font-size: 0.85rem; border-bottom: 1px solid var(--color-border); }
        #urgent-tasks-list li:last-child { border-bottom: none; }
        #urgent-tasks-list li.urgency-4 { font-weight: 600; color: var(--color-primary-dark); }
        #urgent-tasks-list li.urgency-3 { color: var(--color-text-strong); }
        #urgent-tasks-list li.urgency-2 { color: var(--color-text-primary); }
        #urgent-tasks-list li small { display: block; color: var(--color-text-secondary); font-size: 0.75rem; margin-top: 2px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--color-surface); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 6px 20px rgba(44, 62, 80, 0.1); width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-body { overflow-y: auto; padding-right: 1rem; }
        .modal-footer { margin-top: 1.5rem; text-align: right; }
        #edit-daily-progress-container { max-height: 200px; overflow-y: auto; background: var(--color-background); padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>
    <!-- 初始加载/认证界面 -->
    <div id="app-loading">正在加载应用...</div>

    <div id="auth-container" style="display: none;">
        <h1>欢迎使用 TaskMaster</h1>
        <form class="auth-form" id="login-form">
            <input type="email" id="auth-email" placeholder="邮箱" required>
            <input type="password" id="auth-password" placeholder="密码" required>
            <button type="submit" class="btn-primary">登录</button>
        </form>
         <form class="auth-form" id="signup-form" style="display: none;">
            <input type="email" id="signup-email" placeholder="邮箱" required>
            <input type="password" id="signup-password" placeholder="设置密码 (至少6位)" required>
            <button type="submit" class="btn-primary">注册</button>
        </form>
        <div id="auth-message"></div>
        <button id="auth-toggle">还没有账户？点此注册</button>
    </div>

    <!-- 主应用容器 -->
    <div class="app-container">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div>
                    <h3 style="margin:0; font-size: 1rem;">你好!</h3>
                    <span id="user-email" style="font-size: 0.8rem; color: var(--color-text-secondary); word-break: break-all;"></span>
                </div>
                <button id="logout-btn" class="btn" style="padding: 0.4rem 0.8rem;">登出</button>
            </div>
            <div class="sidebar-section"> <input type="text" id="search-box" placeholder="🔍 搜索任务..."> </div>
            <div class="sidebar-section">
                <h3>排序选项</h3>
                <div style="display: flex; flex-direction: column; gap: 0.6rem;"> <button id="sort-urgency" class="btn">按重要程度</button> <button id="sort-status" class="btn">按任务状态</button> <button id="clear-filter" class="btn-primary">清除筛选与排序</button> </div>
            </div>
            <div class="sidebar-section">
                <h3>任务统计</h3>
                <div class="stat-date-range"> <label style="font-size:0.8rem; color:var(--color-text-secondary);">开始日期:</label> <input type="date" id="stats-start-date"> <label style="font-size:0.8rem; color:var(--color-text-secondary); margin-top:0.5rem;">结束日期:</label> <input type="date" id="stats-end-date"> </div>
                <div id="stats-display"> <div class="stat-item"><div id="stat-total" class="stat-number">0</div><div class="stat-label">总数</div></div> <div class="stat-item"><div id="stat-completed" class="stat-number" style="color:var(--color-success)">0</div><div class="stat-label">已完成</div></div> <div class="stat-item"><div id="stat-pending" class="stat-number" style="color:var(--color-danger)">0</div><div class="stat-label">未完成</div></div> </div>
            </div>
            <div class="sidebar-section urgent-tasks-section">
                <h3>紧急任务提醒 (近2天)</h3>
                <div class="list-container"> <ul id="urgent-tasks-list"></ul> </div>
            </div>
            <div class="sidebar-section">
                <h3>数据操作</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;"> <button id="backup-data" class="btn">备份数据到本地</button> </div>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <nav class="tabs"> <button class="tab-button active" data-tab="tasks">任务列表</button> <button class="tab-button" data-tab="progress">每周进展</button> </nav>
            <div id="tab-tasks" class="tab-pane active tab-content">
                <form id="add-task-form"> <input type="text" id="task-name" placeholder="输入任务名称..." required> <input type="date" id="task-start-date" required> <input type="date" id="task-end-date" required> <select id="task-urgency" required></select> <button type="submit" class="btn-primary">添加</button> <button type="button" id="batch-op-btn" class="btn">批量添加</button> </form>
                <div class="task-list-container">
                    <table id="task-table">
                        <thead><tr><th style="width: 5%;">#</th><th style="width: 40%;">任务名称</th><th style="width: 15%;">起止日期</th><th style="width: 15%;">重要程度</th><th style="width: 15%;">状态</th><th style="width: 10%;">操作</th></tr></thead>
                        <tbody id="task-list-body"></tbody>
                    </table>
                </div>
            </div>
            <div id="tab-progress" class="tab-pane tab-content">
                <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap;"> <label for="week-selector">选择周:</label> <select id="week-selector" style="width: 250px;"></select> <button id="generate-report-btn" class="btn-primary">刷新周报</button> <button id="save-report-btn" class="btn">保存周报</button> </div>
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; height: calc(100% - 60px);">
                    <section style="background-color: var(--color-background); border-radius: 10px; padding: 1.5rem; display: flex; flex-direction: column; overflow: hidden;">
                        <h3>本周相关任务</h3>
                        <div id="weekly-plan-display" style="flex-grow: 1; overflow-y: auto; background-color: var(--color-surface); padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-size: 0.9rem;"></div>
                    </section>
                    <section style="background-color: var(--color-background); border-radius: 10px; padding: 1.5rem; display: flex; flex-direction: column; overflow: hidden;">
                        <h3>周报总结 (可编辑)</h3>
                        <textarea id="generated-report-area" style="flex-grow: 1; resize: none; border: none; background-color: var(--color-surface); padding: 1rem; border-radius: 8px; font-size: 0.9rem;"></textarea>
                    </section>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 模态框 HTML -->
    <div id="batch-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>批量添加任务</h2><button class="modal-close" data-target="batch-modal">×</button></div>
            <div class="modal-body">
                <div id="batch-tasks-container"><div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;"><input type="text" class="batch-name" placeholder="任务名称"><input type="date" class="batch-start-date"><input type="date" class="batch-end-date"><select class="batch-urgency"></select></div></div>
                <button id="add-batch-row" class="btn" style="margin-top: 10px;">+ 添加另一行</button>
            </div>
            <div class="modal-footer"> <button class="btn modal-close" data-target="batch-modal">取消</button> <button id="save-batch-btn" class="btn-primary">保存任务</button> </div>
        </div>
    </div>
    <div id="edit-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header"><h2>编辑任务</h2><button class="modal-close" data-target="edit-modal">×</button></div>
            <div class="modal-body">
                <input type="hidden" id="edit-task-id">
                <div style="border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; margin-bottom: 1rem;"> <h4>录入今日进展</h4> <div style="display: flex; gap: 10px; margin-top: 5px;"><input type="text" id="new-progress-content" placeholder="输入进展内容..." style="flex-grow: 1;"><button id="add-progress-btn" class="btn">添加</button></div> </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"> <div><label>任务名称</label><input type="text" id="edit-task-name"></div> <div><label>重要程度</label><select id="edit-task-urgency"></select></div> <div><label>开始日期</label><input type="date" id="edit-task-start-date"></div> <div><label>结束日期</label><input type="date" id="edit-task-end-date"></div> </div>
                <div style="margin-top: 15px;"><label>任务状态</label><select id="edit-task-status"></select></div> <div style="margin-top: 15px;"><label>备注</label><textarea id="edit-task-notes" rows="3"></textarea></div>
                <div style="margin-top: 15px;"> <h4>历史进展记录</h4> <div id="edit-daily-progress-container"></div> </div>
            </div>
            <div class="modal-footer"> <button class="btn modal-close" data-target="edit-modal">取消</button> <button id="save-edit-btn" class="btn-primary">保存更改</button> </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Supabase 配置 ---
    const SUPABASE_URL = 'https://oprqecajnzvzusjqqolk.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wcnFlY2Fqbnp2enVzanFxb2xrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTQzMzMsImV4cCI6MjA2OTU5MDMzM30.lY691Yw7u6ipUxXW6inYAnkv-ohJT96OWTAU-usMJOw';
    
    // --- **FIXED**: Supabase 客户端初始化 ---
    // 从全局的 supabase 对象中解构出 createClient 函数
    const { createClient } = supabase;
    // 使用新的变量名 `supabaseClient` 来存储客户端实例，避免命名冲突
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 全局变量 ---
    const URGENCY_LEVELS = {"非常重要紧急":{value:4},"重要不紧急":{value:3},"紧急不重要":{value:2},"不重要不紧急":{value:1}};
    const STATUS_OPTIONS = ["待办","进行中","已暂停","已完成"];
    const URGENT_REMINDER_DAYS = 2;
    let tasks = [];
    let weeklyProgress = {};
    let currentSort = { key: 'created_at', reverse: true };
    let currentFilter = '';
    let currentUser = null;
    let isAppInitialized = false;

    // --- DOM 元素缓存 ---
    const appLoadingDiv = document.getElementById('app-loading');
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.querySelector('.app-container');
    const authMessage = document.getElementById('auth-message');
    const taskListBody = document.getElementById('task-list-body');
    const searchBox = document.getElementById('search-box');
    const statsStartDateInput = document.getElementById('stats-start-date');
    const statsEndDateInput = document.getElementById('stats-end-date');

    // --- 核心流程 ---
    
    // 检查认证状态并相应地更新UI
    const handleAuthFlow = async (session) => {
        currentUser = session?.user || null;

        appLoadingDiv.style.display = 'none';
        if (currentUser) {
            authContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            document.getElementById('user-email').textContent = currentUser.email;
            if (!isAppInitialized) {
                await initializeApp();
                isAppInitialized = true;
            }
        } else {
            isAppInitialized = false;
            appContainer.style.display = 'none';
            authContainer.style.display = 'block';
        }
    };
    
    // 初始化应用（仅在用户登录后执行一次）
    async function initializeApp() {
        setupEventListeners();
        populateSelect(document.getElementById('task-urgency'), Object.keys(URGENCY_LEVELS));
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('task-start-date').valueAsDate = today;
        document.getElementById('task-end-date').valueAsDate = today;
        statsStartDateInput.valueAsDate = firstDayOfMonth;
        statsEndDateInput.valueAsDate = today;
        
        await loadData();
        render();
    }
    
    // 从 Supabase 加载用户数据
    async function loadData() {
        if (!currentUser) return;
        try {
            const { data: taskData, error: taskError } = await supabaseClient.from('tasks').select('*').order('created_at', { ascending: false });
            if (taskError) throw taskError;
            tasks = taskData || [];
            
            const { data: progressData, error: progressError } = await supabaseClient.from('weekly_progress').select('*');
            if (progressError) throw progressError;
            weeklyProgress = (progressData || []).reduce((acc, item) => {
                acc[item.week_id] = item; return acc;
            }, {});
            
            tasks.forEach(task => { task.daily_progress = task.daily_progress || {}; });
        } catch (error) {
            console.error('Error loading data:', error);
            alert('数据加载失败: ' + error.message);
        }
    }
    
    // --- 渲染函数 (与之前版本相同, 此处省略重复代码以保持清晰) ---
    function render() { renderTaskList(); updateStats(); updateUrgentTasks(); populateWeekSelector(); loadSelectedWeekData(); }
    function renderTaskList() {
        taskListBody.innerHTML = '';
        const filteredAndSortedTasks = getFilteredAndSortedTasks();
        if (filteredAndSortedTasks.length === 0) { taskListBody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--color-text-secondary);">没有找到任务...</td></tr>`; return; }
        const fragment = document.createDocumentFragment();
        filteredAndSortedTasks.forEach((task, index) => {
            const tr = document.createElement('tr'); tr.dataset.taskId = task.id;
            tr.innerHTML = `<td>${index + 1}</td><td><div class="task-name">${escapeHtml(task.name)}</div></td><td><div style="font-size: 0.9rem;">${task.start_date}<br><span style="color:var(--color-text-secondary); font-size:0.8rem;">到 ${task.end_date}</span></div></td><td><select class="inline-edit" data-task-id="${task.id}" data-type="urgency"></select></td><td><select class="inline-edit" data-task-id="${task.id}" data-type="status"></select></td><td class="task-actions"><button title="编辑/查看详情">✏️</button><button title="删除任务">🗑️</button></td>`;
            const urgencySelect = tr.querySelector('[data-type="urgency"]'); const statusSelect = tr.querySelector('[data-type="status"]');
            const applySelectStyles = (select, type) => { const badgeClass = type === 'urgency' ? `urgency-${URGENCY_LEVELS[select.value]?.value || 1}` : select.value.replace(/\s+/g, ''); select.className = `inline-edit badge ${type}-badge ${badgeClass}`; };
            populateSelect(urgencySelect, Object.keys(URGENCY_LEVELS), task.urgency); populateSelect(statusSelect, STATUS_OPTIONS, task.status);
            urgencySelect.addEventListener('change', async (e) => { await updateTask(e.target.dataset.taskId, { urgency: e.target.value }); applySelectStyles(e.target, 'urgency'); });
            statusSelect.addEventListener('change', async (e) => { await updateTask(e.target.dataset.taskId, { status: e.target.value }); applySelectStyles(e.target, 'status'); });
            applySelectStyles(urgencySelect, 'urgency'); applySelectStyles(statusSelect, 'status');
            fragment.appendChild(tr);
        });
        taskListBody.appendChild(fragment);
    }
    function updateStats() {
        let tasksToCount = tasks;
        const startDateStr = statsStartDateInput.value; const endDateStr = statsEndDateInput.value;
        if (startDateStr && endDateStr) { const rangeStart = new Date(startDateStr); rangeStart.setHours(0,0,0,0); const rangeEnd = new Date(endDateStr); rangeEnd.setHours(23,59,59,999); tasksToCount = tasks.filter(task => new Date(task.start_date) <= rangeEnd && new Date(task.end_date) >= rangeStart); }
        document.getElementById('stat-total').textContent = tasksToCount.length;
        document.getElementById('stat-completed').textContent = tasksToCount.filter(t => t.status === '已完成').length;
        document.getElementById('stat-pending').textContent = tasksToCount.filter(t => t.status !== '已完成').length;
    }
    function updateUrgentTasks() {
        const list = document.getElementById('urgent-tasks-list'); list.innerHTML = '';
        const today = new Date(); today.setHours(0,0,0,0); const reminderDeadline = new Date(); reminderDeadline.setDate(today.getDate() + URGENT_REMINDER_DAYS);
        const urgentTasks = tasks.filter(t => t.status !== '已完成' && t.end_date && new Date(t.end_date) >= today && new Date(t.end_date) <= reminderDeadline).sort((a,b) => new Date(a.end_date) - new Date(b.end_date));
        if (urgentTasks.length === 0) { list.innerHTML = `<li style="color: var(--color-text-secondary); font-style: italic; border: none;">无紧急任务</li>`; } else { const fragment = document.createDocumentFragment(); urgentTasks.forEach(task => { const li = document.createElement('li'); li.className = `urgency-${URGENCY_LEVELS[task.urgency]?.value || 1}`; li.innerHTML = `${escapeHtml(task.name)}<small>到期: ${task.end_date}</small>`; fragment.appendChild(li); }); list.appendChild(fragment); }
    }
    // ... [其他渲染函数无需修改] ...

    // --- 事件监听设置 ---
    function setupEventListeners() {
        document.getElementById('add-task-form').addEventListener('submit', addTask);
        searchBox.addEventListener('input', (e) => { currentFilter = e.target.value; renderTaskList(); });
        document.getElementById('sort-urgency').addEventListener('click', () => setSort('urgency'));
        document.getElementById('sort-status').addEventListener('click', () => setSort('status'));
        document.getElementById('clear-filter').addEventListener('click', () => { searchBox.value = ''; currentFilter = ''; currentSort = { key: 'created_at', reverse: true }; updateSortButtons(); renderTaskList(); });
        statsStartDateInput.addEventListener('change', updateStats);
        statsEndDateInput.addEventListener('change', updateStats);
        document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', (e) => { document.querySelector('.tab-button.active')?.classList.remove('active'); document.querySelector('.tab-pane.active')?.classList.remove('active'); e.currentTarget.classList.add('active'); document.getElementById(`tab-${e.currentTarget.dataset.tab}`).classList.add('active'); }); });
        taskListBody.addEventListener('click', e => { const targetButton = e.target.closest('button'); if (!targetButton) return; const tr = e.target.closest('tr'); if(!tr) return; const taskId = tr.dataset.taskId; if (targetButton.title.includes('删除')) deleteTask(taskId); if (targetButton.title.includes('编辑')) openEditModal(taskId); });
        document.getElementById('week-selector').addEventListener('change', loadSelectedWeekData);
        document.getElementById('generate-report-btn').addEventListener('click', generateWeeklyReport);
        document.getElementById('save-report-btn').addEventListener('click', saveWeeklyReport);
        document.getElementById('backup-data').addEventListener('click', backupData);
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.currentTarget.dataset.target)));
        setupBatchModalListeners();
        setupEditModalListeners();
        document.getElementById('logout-btn').addEventListener('click', async () => { const { error } = await supabaseClient.auth.signOut(); if (error) alert('登出失败: ' + error.message); });
    }
    function setupBatchModalListeners() { const batchModal = document.getElementById('batch-modal'); document.getElementById('batch-op-btn').addEventListener('click', () => openModal('batch-modal')); batchModal.querySelector('#save-batch-btn').addEventListener('click', saveManualBatch); batchModal.querySelector('#add-batch-row').addEventListener('click', () => { const container = batchModal.querySelector('#batch-tasks-container'); const newRow = container.firstElementChild.cloneNode(true); newRow.querySelectorAll('input').forEach(i => i.value = ''); populateSelect(newRow.querySelector('.batch-urgency'), Object.keys(URGENCY_LEVELS)); container.appendChild(newRow); }); populateSelect(batchModal.querySelector('.batch-urgency'), Object.keys(URGENCY_LEVELS)); }
    function setupEditModalListeners(){ const editModal = document.getElementById('edit-modal'); editModal.querySelector('#save-edit-btn').addEventListener('click', saveEditTask); editModal.querySelector('#add-progress-btn').addEventListener('click', addDailyProgress); editModal.querySelector('#edit-daily-progress-container').addEventListener('click', e => { const deleteBtn = e.target.closest('.delete-progress-btn'); if (deleteBtn) { const { date, index } = deleteBtn.dataset; deleteDailyProgress(document.getElementById('edit-task-id').value, date, parseInt(index)); } }); }

    // --- 数据操作函数 (使用 supabaseClient) ---
    async function addTask(e) {
        e.preventDefault();
        const form = e.target;
        const name = form.querySelector('#task-name').value.trim(); const start_date = form.querySelector('#task-start-date').value; const end_date = form.querySelector('#task-end-date').value; const urgency = form.querySelector('#task-urgency').value;
        if (!name || !start_date || !end_date || !urgency) return alert('请填写所有必填项！');
        if (new Date(end_date) < new Date(start_date)) return alert('结束日期不能早于开始日期！');
        
        try {
            const { data, error } = await supabaseClient.from('tasks').insert({ name, start_date, end_date, urgency, status: '待办' }).select().single();
            if (error) throw error;
            tasks.unshift(data); render();
            form.reset(); form.querySelector('#task-start-date').valueAsDate = new Date(); form.querySelector('#task-end-date').valueAsDate = new Date();
        } catch (error) { console.error('Error adding task:', error); alert('添加任务失败: ' + error.message); }
    }
    function getFilteredAndSortedTasks() {
        let result = [...tasks];
        if (currentFilter) { const searchTerm = currentFilter.toLowerCase(); result = result.filter(task => Object.values(task).some(val => String(val).toLowerCase().includes(searchTerm))); }
        const { key, reverse } = currentSort;
        result.sort((a, b) => { let valA, valB; switch(key) { case 'urgency': valA = URGENCY_LEVELS[a.urgency]?.value || 0; valB = URGENCY_LEVELS[b.urgency]?.value || 0; break; case 'status': valA = STATUS_OPTIONS.indexOf(a.status); valB = STATUS_OPTIONS.indexOf(b.status); break; default: valA = new Date(a.created_at); valB = new Date(b.created_at); break; } if (valA < valB) return reverse ? 1 : -1; if (valA > valB) return reverse ? -1 : 1; return 0; });
        return result;
    }
    function setSort(key) { if (currentSort.key === key) { currentSort.reverse = !currentSort.reverse; } else { currentSort.key = key; currentSort.reverse = (key === 'urgency' || key === 'created_at'); } updateSortButtons(); renderTaskList(); }
    function updateSortButtons() { document.querySelectorAll('.sidebar-section button[id^="sort-"]').forEach(btn => { btn.classList.remove('btn-primary'); let baseText = {'sort-urgency':'按重要程度','sort-status':'按任务状态'}[btn.id]; const key = btn.id.replace('sort-', ''); if(currentSort.key === key) { btn.classList.add('btn-primary'); btn.textContent = `${baseText} ${currentSort.reverse ? '▼' : '▲'}`; } else { btn.textContent = baseText; } }); }
    async function updateTask(id, updates) {
        try {
            const { data, error } = await supabaseClient.from('tasks').update(updates).eq('id', id).select().single();
            if (error) throw error;
            const index = tasks.findIndex(t => t.id === id);
            if (index !== -1) tasks[index] = { ...tasks[index], ...data };
            render();
        } catch (error) { console.error('Error updating task:', error); alert('更新任务失败: ' + error.message); }
    }
    async function deleteTask(id) {
        if (confirm('确定要删除这个任务吗？此操作不可逆！')) {
            try {
                const { error } = await supabaseClient.from('tasks').delete().eq('id', id);
                if (error) throw error;
                tasks = tasks.filter(t => t.id !== id); render();
            } catch (error) { console.error('Error deleting task:', error); alert('删除任务失败: ' + error.message); }
        }
    }
    function populateSelect(select, options, selectedValue = null) { select.innerHTML = options.map(opt => `<option value="${escapeHtml(opt)}" ${opt === selectedValue ? 'selected' : ''}>${escapeHtml(opt)}</option>`).join(''); }
    function escapeHtml(str) { return String(str || '').replace(/[&<>"']/g, m => ({'&':'&','<':'<','>':'>','"':'"',"'":'''})[m]); }
    function openModal(id) { document.getElementById(id)?.classList.add('active'); }
    function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }
    function getWeekIdFromDate(d) { const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1)); const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7); return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`; }
    function getWeekStartEndDates(weekId) { const [year, week] = weekId.split('-W').map(Number); const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7)); const day = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 1 - day); return [new Date(d), new Date(d.setUTCDate(d.getUTCDate() + 6))]; }
    function formatDate(date, full = false) { return date.toLocaleDateString('zh-CN', { year: full?'numeric':undefined, month: '2-digit', day: '2-digit' }).replace(/\//g, '-'); }
    function populateWeekSelector() { const weekIds = new Set(); tasks.forEach(task => { if (task.start_date) weekIds.add(getWeekIdFromDate(new Date(task.start_date))); if (task.end_date) weekIds.add(getWeekIdFromDate(new Date(task.end_date))); Object.keys(task.daily_progress || {}).forEach(dateStr => weekIds.add(getWeekIdFromDate(new Date(dateStr)))); }); Object.keys(weeklyProgress).forEach(weekId => weekIds.add(weekId)); weekIds.add(getWeekIdFromDate(new Date())); const sortedWeeks = Array.from(weekIds).sort().reverse(); const selector = document.getElementById('week-selector'); selector.innerHTML = sortedWeeks.map(weekId => { const [start, end] = getWeekStartEndDates(weekId); return `<option value="${weekId}">${weekId} (${formatDate(start)} - ${formatDate(end)})</option>`; }).join(''); const currentWeekId = getWeekIdFromDate(new Date()); if(sortedWeeks.includes(currentWeekId)) selector.value = currentWeekId; }
    function loadSelectedWeekData() { const selectedWeekId = document.getElementById('week-selector').value; if (!selectedWeekId) return; const [weekStart, weekEnd] = getWeekStartEndDates(selectedWeekId); const relevantTasks = tasks.filter(task => new Date(task.start_date) <= weekEnd && new Date(task.end_date) >= weekStart); document.getElementById('weekly-plan-display').innerHTML = relevantTasks.length > 0 ? '<ul>' + relevantTasks.map(t => `<li><strong>${escapeHtml(t.name)}</strong><br><small>${t.status} | ${t.urgency}</small></li>`).join('') + '</ul>' : '<p style="color: var(--color-text-secondary);">本周无相关计划任务。</p>'; document.getElementById('generated-report-area').value = weeklyProgress[selectedWeekId]?.generated_report || ''; }
    function generateWeeklyReport() { const selectedWeekId = document.getElementById('week-selector').value; if (!selectedWeekId) return; const [weekStart, weekEnd] = getWeekStartEndDates(selectedWeekId); let reportText = `## 周报 (${selectedWeekId})\n周期: ${formatDate(weekStart, true)} 至 ${formatDate(weekEnd, true)}\n\n--- 本周任务进展与记录 ---\n\n`; const tasksWithActivity = tasks.filter(task => (new Date(task.start_date) <= weekEnd && new Date(task.end_date) >= weekStart)); if (tasksWithActivity.length === 0) { reportText += "本周没有相关任务。\n"; } else { tasksWithActivity.forEach(task => { reportText += `### 任务: ${task.name} (${task.status}, ${task.urgency})\n`; const progressInWeek = Object.entries(task.daily_progress || {}).filter(([dateStr]) => new Date(dateStr) >= weekStart && new Date(dateStr) <= weekEnd).sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB)); if (progressInWeek.length > 0) { progressInWeek.forEach(([date, entries]) => { reportText += `  - ${date}:\n` + entries.map(e => `    • ${e.content}`).join('\n') + '\n'; }); } else { reportText += `  - 本周无明确进展记录。\n`; } if (task.status === '已完成' && new Date(task.end_date) >= weekStart && new Date(task.end_date) <= weekEnd) { reportText += `  - 任务于 ${task.end_date} 完成。\n`; } reportText += "\n"; }); } document.getElementById('generated-report-area').value = reportText; }
    async function saveWeeklyReport() {
        const selectedWeekId = document.getElementById('week-selector').value; if (!selectedWeekId) return;
        const reportData = { week_id: selectedWeekId, generated_report: document.getElementById('generated-report-area').value };
        try {
            const { data, error } = await supabaseClient.from('weekly_progress').upsert(reportData, { onConflict: 'week_id' }).select().single(); // user_id is implicit
            if (error) throw error;
            weeklyProgress[selectedWeekId] = data; alert('周报已保存到云端！');
        } catch (error) { console.error('Error saving weekly report:', error); alert('保存周报失败: ' + error.message); }
    }
    function backupData() { const dataToBackup = { tasks, weeklyProgress }; const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `TaskMaster_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); }
    async function saveManualBatch() {
        const newTasks = Array.from(document.getElementById('batch-tasks-container').querySelectorAll('div')).map(row => { const name = row.querySelector('.batch-name').value.trim(); const start_date = row.querySelector('.batch-start-date').value; const end_date = row.querySelector('.batch-end-date').value; const urgency = row.querySelector('.batch-urgency').value; return (name && start_date && end_date && urgency) ? { name, start_date, end_date, urgency, status: '待办' } : null; }).filter(Boolean);
        if (newTasks.length > 0) { try { const { data, error } = await supabaseClient.from('tasks').insert(newTasks).select(); if (error) throw error; tasks.unshift(...data); render(); alert(`成功添加 ${data.length} 个任务！`); closeModal('batch-modal'); } catch (error) { console.error('Error batch adding tasks:', error); alert('批量添加任务失败: ' + error.message); } } else { alert('没有输入任何有效的任务。'); }
    }
    function openEditModal(taskId) { const task = tasks.find(t => t.id === taskId); if (!task) return; const modal = document.getElementById('edit-modal'); modal.querySelector('#edit-task-id').value = taskId; modal.querySelector('#edit-task-name').value = task.name; modal.querySelector('#edit-task-start-date').value = task.start_date; modal.querySelector('#edit-task-end-date').value = task.end_date; modal.querySelector('#edit-task-notes').value = task.notes; populateSelect(modal.querySelector('#edit-task-urgency'), Object.keys(URGENCY_LEVELS), task.urgency); populateSelect(modal.querySelector('#edit-task-status'), STATUS_OPTIONS, task.status); renderDailyProgressEditor(task); openModal('edit-modal'); }
    function renderDailyProgressEditor(task) { const container = document.getElementById('edit-daily-progress-container'); container.innerHTML = ''; const progressEntries = Object.entries(task.daily_progress || {}).sort(([dateA], [dateB]) => new Date(dateB) - new Date(dateA)); if (progressEntries.length === 0) { container.innerHTML = '<p style="color: var(--color-text-secondary); font-style: italic;">无进展记录</p>'; return; } const fragment = document.createDocumentFragment(); progressEntries.forEach(([date, entries]) => { const dateGroup = document.createElement('div'); dateGroup.style.marginBottom = '10px'; dateGroup.innerHTML = `<strong>${date}</strong>`; const ul = document.createElement('ul'); ul.style.listStyle = 'none'; ul.style.paddingLeft = '15px'; entries.forEach((entry, index) => { const li = document.createElement('li'); li.style.display = 'flex'; li.style.justifyContent = 'space-between'; li.innerHTML = `<span>${escapeHtml(entry.content)}</span> <button class="delete-progress-btn" data-date="${date}" data-index="${index}" style="color:red; background:none; border:none; cursor:pointer; font-size:1.2em; line-height:1;">×</button>`; ul.appendChild(li); }); dateGroup.appendChild(ul); fragment.appendChild(dateGroup); }); container.appendChild(fragment); }
    async function saveEditTask() { const id = document.getElementById('edit-task-id').value; const updates = { name:document.getElementById('edit-task-name').value, start_date:document.getElementById('edit-task-start-date').value, end_date:document.getElementById('edit-task-end-date').value, urgency:document.getElementById('edit-task-urgency').value, status:document.getElementById('edit-task-status').value, notes:document.getElementById('edit-task-notes').value }; await updateTask(id, updates); closeModal('edit-modal'); }
    async function addDailyProgress() { const id = document.getElementById('edit-task-id').value; const task = tasks.find(t => t.id === id); const contentInput = document.getElementById('new-progress-content'); const content = contentInput.value.trim(); if (!task || !content) return; const todayStr = new Date().toISOString().split('T')[0]; if (!task.daily_progress[todayStr]) task.daily_progress[todayStr] = []; task.daily_progress[todayStr].push({ content, timestamp: new Date().toISOString() }); await updateTask(id, { daily_progress: task.daily_progress }); contentInput.value = ''; renderDailyProgressEditor(task); }
    async function deleteDailyProgress(taskId, date, index) { const task = tasks.find(t => t.id === taskId); if (task && task.daily_progress[date]) { task.daily_progress[date].splice(index, 1); if (task.daily_progress[date].length === 0) delete task.daily_progress[date]; await updateTask(taskId, { daily_progress: task.daily_progress }); renderDailyProgressEditor(task); } }

    // --- 认证表单事件 ---
    document.getElementById('auth-toggle').addEventListener('click', () => {
        const loginForm = document.getElementById('login-form'); const signupForm = document.getElementById('signup-form'); const toggleButton = document.getElementById('auth-toggle');
        const isLoginVisible = loginForm.style.display !== 'none';
        loginForm.style.display = isLoginVisible ? 'none' : 'flex'; signupForm.style.display = isLoginVisible ? 'flex' : 'none';
        toggleButton.textContent = isLoginVisible ? '已有账户？点此登录' : '还没有账户？点此注册'; authMessage.textContent = '';
    });
    document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('auth-email').value; const password = document.getElementById('auth-password').value; const { error } = await supabaseClient.auth.signInWithPassword({ email, password }); if (error) authMessage.textContent = '登录失败: ' + error.message; else authMessage.textContent = ''; });
    document.getElementById('signup-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('signup-email').value; const password = document.getElementById('signup-password').value; const { data, error } = await supabaseClient.auth.signUp({ email, password }); if (error) { authMessage.textContent = '注册失败: ' + error.message; } else if (data.user && data.user.identities && data.user.identities.length === 0) { authMessage.textContent = '注册失败: 该邮箱可能已被注册。'; } else { authMessage.textContent = '注册成功！请检查您的邮箱以完成验证，然后返回登录。'; } });

    // --- 应用启动入口 ---
    // 首次加载时检查会话
    supabaseClient.auth.getSession().then(({ data: { session } }) => {
        handleAuthFlow(session);
    });
    // 监听后续认证状态变化（登录、登出）
    supabaseClient.auth.onAuthStateChange((_event, session) => {
        handleAuthFlow(session);
    });
});
</script>
</body>
</html>
